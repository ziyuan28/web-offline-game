<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>çµçŸ³ä¿®ä»™ä¼  - æœºç¼˜ä¿®å¤ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --border-color: #333;
            --text-main: #e0e0e0;
            --gold: #ffd700;
            --blue: #4fc3f7;
            --red: #ff5252;
            --green: #69f0ae;
            --purple: #b388ff;
            --card-bg: #252525;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        .app-container {
            width: 1000px;
            height: 750px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* --- Top Section --- */
        .top-section { display: flex; gap: 15px; flex: 2; min-height: 0; }
        .status-panel { width: 280px; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.3); position: relative; }
        .main-panel { flex: 1; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* --- Tabs --- */
        .nav-tabs { display: flex; background: #111; border-bottom: 1px solid var(--border-color); }
        .nav-item { padding: 15px 25px; cursor: pointer; color: #888; transition: 0.2s; border-right: 1px solid var(--border-color); font-weight: bold; }
        .nav-item:hover { color: #ccc; background: #1a1a1a; }
        .nav-item.active { color: var(--gold); background: var(--panel-bg); border-bottom: 2px solid var(--gold); }

        /* --- Content --- */
        .view-content { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
        .hidden { display: none !important; }

        /* Scene: Spirit Orb */
        .scene-area {
            flex: 1; display: flex; justify-content: center; align-items: center;
            border: 1px dashed #333; border-radius: 8px; margin-bottom: 20px;
            background: radial-gradient(circle at center, #2a2a2a 0%, #1e1e1e 70%);
            position: relative; overflow: hidden;
        }
        .spirit-orb {
            width: 140px; height: 140px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--blue), transparent);
            box-shadow: 0 0 40px var(--blue), inset 0 0 20px #fff;
            animation: breathe 4s infinite ease-in-out;
            display: flex; justify-content: center; align-items: center;
            font-size: 32px; cursor: pointer; transition: transform 0.1s; z-index: 10;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        .spirit-orb:active { transform: scale(0.92); }

        /* Floating Text Animation */
        .floating-text {
            position: absolute; color: var(--green); font-weight: bold; font-size: 20px;
            pointer-events: none; animation: floatUp 1s forwards; text-shadow: 1px 1px 2px black; z-index: 999;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        /* Market Grid */
        .market-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding-bottom: 20px; }
        .item-card {
            background: var(--card-bg); border: 1px solid #333; border-radius: 6px; padding: 12px;
            display: flex; flex-direction: column; justify-content: space-between; min-height: 100px;
        }
        .item-card:hover { border-color: #555; background: #2a2a2a; }
        .item-head { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .item-name { font-weight: bold; color: var(--gold); }
        .item-lvl { font-size: 12px; color: var(--purple); background: #111; padding: 2px 6px; border-radius: 4px; }
        .item-desc { font-size: 12px; color: #888; margin-bottom: 10px; line-height: 1.4; flex: 1; }
        .btn-buy {
            background: #333; border: 1px solid #444; color: #ccc; padding: 8px; border-radius: 4px;
            cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center;
        }
        .btn-buy:hover:not(:disabled) { background: var(--gold); color: #000; border-color: var(--gold); }
        .btn-buy:active:not(:disabled) { transform: scale(0.98); }
        .btn-buy:disabled { opacity: 0.5; cursor: not-allowed; }

        /* General UI */
        .header { font-size: 18px; color: var(--gold); border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; align-items: center; }
        .progress-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--purple)); width: 0%; transition: width 0.2s ease-out; }
        
        .log-panel { flex: 1; background: #111; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; min-height: 0; font-family: 'Consolas', monospace; }
        .log-container { flex: 1; overflow-y: auto; font-size: 13px; line-height: 1.6; }
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .log-time { color: #555; margin-right: 8px; }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 0 40px var(--blue); opacity: 0.9; }
            50% { transform: scale(1.05); box-shadow: 0 0 70px var(--purple); opacity: 1; }
        }

        /* Modal (å¼¹çª—ä¿®å¤) */
        #event-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .modal-content {
            background: #252525; width: 450px; padding: 25px;
            border: 1px solid var(--red); box-shadow: 0 0 30px rgba(255, 82, 82, 0.3);
            border-radius: 12px; text-align: center;
        }
        .modal-btn {
            width: 100%; margin-top: 10px; padding: 15px;
            font-size: 16px; background: #333; color: #fff;
            border: 1px solid #555; cursor: pointer; transition: 0.2s;
        }
        .modal-btn:hover { background: #444; border-color: #777; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="top-section">
        <!-- å·¦ä¾§çŠ¶æ€æ  -->
        <div class="status-panel">
            <div class="header">é“å‹é¢æ¿</div>
            <div class="stat-row"><span>å¢ƒç•Œ</span> <span id="realm-text" style="color:var(--purple); font-weight:bold;">å‡¡äºº</span></div>
            <div class="stat-row"><span>çµçŸ³</span> <span style="color:var(--gold); font-weight:bold;"><span id="gold-text">0</span></span></div>
            
            <div style="height:1px; background:#333; margin:10px 0;"></div>
            
            <!-- æœºç¼˜å€’è®¡æ—¶ç§»åˆ°è¿™é‡Œï¼Œæ›´åŠ é†’ç›® -->
            <div class="stat-row" style="color:#aaa;">
                <span>æœºç¼˜å€’è®¡æ—¶</span>
                <span id="event-timer" style="color:var(--red); font-weight:bold;">30</span>
            </div>

            <div class="stat-row" title="æ¥è‡ªèšçµé˜µ"><span>çµçŸ³äº§å‡º</span> <span><span id="income-text">0</span> /ç§’</span></div>
            <div class="stat-row" title="æ¥è‡ªçµå…½"><span>è‡ªåŠ¨ä¿®ä¸º</span> <span><span id="auto-exp-text">0</span> /ç§’</span></div>
            <div class="stat-row" title="æ‰‹åŠ¨ç‚¹å‡»æ”¶ç›Š"><span>æ‰“åæ•ˆç‡</span> <span><span id="click-power">1</span> /æ¬¡</span></div>
            
            <div style="margin-top:auto; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa;">
                    <span>ä¿®ä¸ºè¿›åº¦</span>
                    <span><span id="exp-text">0</span> / <span id="max-exp-text">100</span></span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="exp-bar"></div></div>
            </div>

            <!-- æŠ¤èº«ç¬¦çŠ¶æ€ -->
            <div id="amulet-status" style="font-size:12px; color:var(--green); margin-bottom:10px; display:none; text-align:center;">
                ğŸ›¡ï¸ æŠ¤èº«ç¬¦ç”Ÿæ•ˆä¸­ (å¤±è´¥ä¸æ‰çº§)
            </div>

            <button id="break-btn" onclick="game.attemptBreakthrough()" style="width:100%; padding:12px; background:#223; border:1px solid var(--blue); color:var(--blue); cursor:pointer; border-radius:4px; font-weight:bold;">
                âš¡ å†²å‡»ç“¶é¢ˆ (<span id="chance-text">100%</span>)
            </button>
        </div>

        <!-- å³ä¾§ä¸»ç•Œé¢ -->
        <div class="main-panel">
            <div class="nav-tabs">
                <div class="nav-item active" onclick="ui.switchTab('cave', this)">æ´åºœ</div>
                <div class="nav-item" onclick="ui.switchTab('market', this)">åŠå¸‚</div>
            </div>

            <!-- Tab: æ´åºœ -->
            <div id="view-cave" class="view-content">
                <div class="scene-area" id="scene-area">
                    <!-- ç‚¹å‡»äº‹ä»¶ä¼ é€’ event å‚æ•°ä»¥è·å–åæ ‡ -->
                    <div class="spirit-orb" onmousedown="game.manualCultivate(event)">é“</div>
                    <div style="position: absolute; bottom: 20px; font-size: 14px; color: #888;">
                        ç‚¹å‡»ååçµæ°”
                    </div>
                </div>
                <div style="text-align:center; color:#555; font-size:12px; font-style:italic;">
                    â€œæœºç¼˜å€’è®¡æ—¶å·²ç§»è‡³å·¦ä¾§é¢æ¿ã€‚â€
                </div>
            </div>

            <!-- Tab: åŠå¸‚ -->
            <div id="view-market" class="view-content hidden">
                <div class="market-grid" id="market-list">
                    <!-- JS åŠ¨æ€ç”Ÿæˆå•†å“ -->
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ—¥å¿— -->
    <div class="log-panel">
        <div class="log-container" id="log-container"></div>
    </div>
</div>

<!-- éšæœºäº‹ä»¶å¼¹çª— (å·²ä¿®å¤) -->
<div id="event-modal">
    <div class="modal-content">
        <h2 style="color:var(--red); margin-top:0;" id="modal-title">å¥‡é‡</h2>
        <p id="modal-desc" style="color:#ccc; line-height:1.6; margin:20px 0;">å†…å®¹...</p>
        <div id="modal-choices"></div>
    </div>
</div>

<script>
    /* --- 1. é…ç½®ä¸æ•°æ® --- */
    const CONFIG = {
        realms: ["å‡¡äºº", "ç‚¼æ°”åˆæœŸ", "ç‚¼æ°”ä¸­æœŸ", "ç‚¼æ°”åæœŸ", "ç­‘åŸºæœŸ", "é‡‘ä¸¹å¤§é“", "å…ƒå©´è€ç¥–", "åŒ–ç¥å¤©å°Š", "ç‚¼è™šåˆé“"],
        eventInterval: 300 // 300ç§’è§¦å‘ä¸€æ¬¡æœºç¼˜
    };

    const defaultState = {
        gold: 0,
        exp: 0,
        maxExp: 100,
        realmIdx: 0,
        lastSave: Date.now(),
        incomeLvl: 1, clickLvl: 1, petLvl: 0,
        hasAmulet: false, luckBonus: 0
    };

    let state = { ...defaultState };
    let eventTimer = CONFIG.eventInterval;

    /* --- 2. éšæœºäº‹ä»¶åº“ (ä¿®å¤å¹¶å›å½’) --- */
    const EVENTS = [
        {
            t: "ä¹ä¸çš„é¦ˆèµ ",
            d: "è·¯è¾¹ä¸€ä¸ªä¹ä¸éè¦å¡ç»™ä½ ä¸€æœ¬ç ´ä¹¦ï¼Œè¯´ä½ æ˜¯ä¸‡ä¸­æ— ä¸€çš„ç»ƒæ­¦å¥‡æ‰ã€‚",
            opts: [
                { txt: "æ¥å— (+100ä¿®ä¸º)", act: (g) => { g.addExp(100); return "ç ´ä¹¦ç«Ÿç„¶æ˜¯æ®‹ç¼ºçš„å¿ƒæ³•ï¼ä¿®ä¸ºå¤§å¢ã€‚"; } },
                { txt: "å«Œè„èµ°å¼€", act: (g) => { return "ä½ é”™è¿‡äº†æœºç¼˜ã€‚"; } }
            ]
        },
        {
            t: "å¤©é™æ¨ªè´¢",
            d: "ä½ åœ¨åå±±é—²é€›ï¼Œè¢«ä¸€å—çªå‡ºçš„çŸ³å¤´ç»Šå€’ï¼Œä»”ç»†ä¸€çœ‹...",
            opts: [
                { txt: "æŒ–å¼€çœ‹çœ‹ (+100çµçŸ³)", act: (g) => { state.gold+=100; return "ç«Ÿç„¶æ˜¯ä¸€å—ä¸‹å“çµçŸ³ï¼å‘è´¢äº†ã€‚"; } }
            ]
        },
        {
            t: "å¿ƒé­”è¯•ç‚¼",
            d: "æ‰“åæ—¶å¿½æ„Ÿå¿ƒç¥ä¸å®ï¼Œä¼¼æœ‰å¤©é­”ä¹±èˆã€‚",
            opts: [
                { txt: "å‡ç¥é™æ°” (50%æ¦‚ç‡+300ä¿®ä¸º)", act: (g) => { 
                    if(Math.random()>0.5) { g.addExp(300); return "æˆ˜èƒœå¿ƒé­”ï¼Œé“å¿ƒæ›´åŠ ç¨³å›ºï¼"; }
                    else { g.addExp(-50); return "å¿ƒç¥å—æŸï¼ŒæŸå¤±äº†å°‘é‡ä¿®ä¸ºã€‚"; }
                }},
                { txt: "ç«‹åˆ»åœæ­¢", act: (g) => { return "ä½ åŠæ—¶æ”¶åŠŸï¼Œæ— äº‹å‘ç”Ÿã€‚"; } }
            ]
        },
        {
            t: "é»‘å¸‚äº¤æ˜“",
            d: "æœ‰äººåœ¨å…œå”®ä¸€æ‰¹æ¥è·¯ä¸æ˜çš„è¯è‰ã€‚",
            opts: [
                { txt: "èŠ±è´¹50çµçŸ³èµŒä¸€æŠŠ", act: (g) => { 
                    if(state.gold < 50) return "çµçŸ³ä¸è¶³ï¼";
                    state.gold -= 50;
                    if(Math.random()>0.4) { g.addExp(200); return "å¥½è¯ï¼ä¿®ä¸ºç²¾è¿›ã€‚"; }
                    else { return "å…¨æ˜¯æ¯è‰ï¼Œè¢«éª—äº†ï¼"; }
                }},
                { txt: "ç¦»å¼€", act: (g) => { return "ä½ è°¨æ…åœ°ç¦»å¼€äº†ã€‚"; } }
            ]
        }
    ];

    /* --- 3. åŠå¸‚å•†å“å®šä¹‰ --- */
    const MARKET_ITEMS = [
        {
            id: 'income', name: 'ğŸ’ èšçµé˜µæ³•', type: 'upgrade',
            desc: 'å‡çº§æ´åºœçµè„‰ï¼Œå¢åŠ çµçŸ³è‡ªåŠ¨äº§å‡ºã€‚',
            baseCost: 50, costMult: 1.5,
            getVal: (s) => s.incomeLvl,
            effect: (s) => `äº§å‡º +1/s`,
            action: (s) => { s.incomeLvl++; return "èšçµé˜µå‡çº§ï¼çµæ°”æ›´åŠ æµ“éƒäº†ã€‚"; }
        },
        {
            id: 'click', name: 'ğŸ“– åçº³å¿ƒæ³•', type: 'upgrade',
            desc: 'æ”¹è‰¯å‘¼å¸æ³•é—¨ï¼Œæå‡æ¯æ¬¡æ‰“åçš„ä¿®ä¸ºã€‚',
            baseCost: 100, costMult: 1.6,
            getVal: (s) => s.clickLvl,
            effect: (s) => `ç‚¹å‡» +2`,
            action: (s) => { s.clickLvl++; return "å¿ƒæ³•ç²¾è¿›ï¼æ‰“åæ•ˆç‡æå‡ã€‚"; }
        },
        {
            id: 'pet', name: 'ğŸ¦Š é¥²å…»çµå…½', type: 'upgrade',
            desc: 'é©¯å…»ä¸€åªçµç‹ï¼Œå®ƒä¼šå¸®ä½ è‡ªåŠ¨ä¿®ç‚¼ã€‚',
            baseCost: 1000, costMult: 1.8,
            getVal: (s) => s.petLvl,
            effect: (s) => `è‡ªåŠ¨ä¿®ä¸º +${(s.petLvl+1)*2}/s`,
            action: (s) => { s.petLvl++; return "çµå…½æˆé•¿äº†ï¼å®ƒå¼€å§‹å¸®ä½ èšé›†ä¿®ä¸ºã€‚"; }
        },
        {
            id: 'pill_s', name: 'ğŸ’Š èšæ°”æ•£', type: 'con',
            desc: 'ç‚¼æ°”æœŸä¿®å£«å¸¸ç”¨çš„ä¸¹è¯ï¼Œæœç”¨å¯å¢è¿›ä¿®ä¸ºã€‚',
            cost: 20,
            effect: () => `ä¿®ä¸º +50`,
            action: (s) => { game.addExp(50); return "æœç”¨èšæ°”æ•£ï¼Œæš–æµæ¶Œéå…¨èº«ã€‚"; }
        },
        {
            id: 'luck', name: 'ğŸ€ æ°”è¿é‡‘é¾™', type: 'con',
            desc: 'è´­ä¹°ä¸€æ¬¡æ€§çš„å¤©é“æ°”è¿ï¼Œæå‡ä¸‹æ¬¡çªç ´æˆåŠŸç‡ã€‚',
            cost: 300,
            effect: () => `æˆåŠŸç‡ +5%`,
            action: (s) => { s.luckBonus += 0.05; return "æ°”è¿åŠ èº«ï¼ä¸‹æ¬¡çªç ´å¦‚æœ‰ç¥åŠ©ã€‚"; }
        },
        {
            id: 'amulet', name: 'ğŸ›¡ï¸ æ›¿èº«è‰äºº', type: 'unique',
            desc: 'çè´µçš„æ›¿èº«æ³•å®ã€‚æŠµæŒ¡ä¸€æ¬¡çªç ´å¤±è´¥çš„æƒ©ç½šã€‚',
            cost: 500,
            req: (s) => !s.hasAmulet,
            effect: () => `ä¿å‘½ä¸€æ¬¡`,
            action: (s) => { s.hasAmulet = true; return "è£…å¤‡æ›¿èº«è‰äººï¼å¿ƒé‡Œè¸å®å¤šäº†ã€‚"; }
        }
    ];

    /* --- 4. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ --- */
    const game = {
        init() {
            this.load();
            this.calcOffline();
            this.renderMarket();
            this.updateUI();
            
            setInterval(() => this.tick(), 1000);
            setInterval(() => this.save(), 10000);
            
            ui.log("é“å‹è¯·äº†ï¼ç‚¹å‡»çµçƒä¿®ç‚¼ï¼Œå·¦ä¾§å…³æ³¨æœºç¼˜å€’è®¡æ—¶ã€‚");
        },

        tick() {
            // èµ„æºäº§å‡º
            const income = this.getIncomeRate();
            state.gold += income;
            if (state.petLvl > 0) this.addExp(state.petLvl * 2);

            // æœºç¼˜é€»è¾‘ (ä¿®å¤ç‚¹)
            eventTimer--;
            if(eventTimer <= 0) {
                this.triggerEvent();
                eventTimer = CONFIG.eventInterval;
            }
            this.updateUI();
        },

        triggerEvent() {
            const evt = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            const modal = document.getElementById('event-modal');
            const choices = document.getElementById('modal-choices');
            
            document.getElementById('modal-title').innerText = evt.t;
            document.getElementById('modal-desc').innerText = evt.d;
            choices.innerHTML = "";

            evt.opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'modal-btn';
                btn.innerText = opt.txt;
                btn.onclick = () => {
                    const res = opt.act(this);
                    if(res !== "çµçŸ³ä¸è¶³ï¼") modal.style.display = "none";
                    ui.log(`[å¥‡é‡] ${res}`);
                    this.updateUI();
                };
                choices.appendChild(btn);
            });
            modal.style.display = "flex";
        },

        getClickPower() { return 1 + Math.floor(state.realmIdx * 1.5) + (state.clickLvl - 1) * 2; },
        getIncomeRate() { return 1 + Math.floor((state.incomeLvl - 1) * 1.5); },

        manualCultivate(e) {
            const gain = this.getClickPower();
            this.addExp(gain);
            
            let x, y;
            if (e) { x = e.clientX; y = e.clientY; } 
            else {
                const rect = document.getElementById('scene-area').getBoundingClientRect();
                x = rect.left + rect.width / 2; y = rect.top + rect.height / 2;
            }
            ui.showFloatingText(x, y, `+${gain} ä¿®ä¸º`);
        },

        addExp(val) {
            if (state.exp >= state.maxExp) return;
            state.exp += val;
            if (state.exp > state.maxExp) state.exp = state.maxExp;
            this.updateUI();
        },

        buy(itemIndex) {
            const item = MARKET_ITEMS[itemIndex];
            let cost = item.cost;
            if (item.type === 'upgrade') cost = Math.floor(item.baseCost * Math.pow(item.costMult, item.getVal(state) - 1));

            if (state.gold >= cost) {
                state.gold -= cost;
                const msg = item.action(state);
                ui.log(msg);
                this.renderMarket();
                this.updateUI();
            } else {
                ui.log("çµçŸ³ä¸è¶³ï¼æ— æ³•è´­ä¹° " + item.name);
            }
        },

        attemptBreakthrough() {
            if (state.exp < state.maxExp) { ui.log("ä¿®ä¸ºæœªæ»¡ï¼Œæ— æ³•æ„Ÿåº”å¤©åŠ«ã€‚"); return; }
            let chance = Math.max(0.1, 1.0 - (state.realmIdx * 0.1)) + state.luckBonus;
            
            if (Math.random() < chance) {
                state.realmIdx++;
                state.exp = 0;
                state.maxExp = Math.floor(state.maxExp * 2.5);
                state.luckBonus = 0;
                ui.log(`=== æ¸¡åŠ«æˆåŠŸï¼æ™‹å‡ [${CONFIG.realms[state.realmIdx]}] ===`);
            } else {
                state.luckBonus = 0;
                if (state.hasAmulet) {
                    state.hasAmulet = false;
                    ui.log("çªç ´å¤±è´¥ï¼æ›¿èº«è‰äººç‚¸è£‚ï¼Œä¿ä½äº†ä¿®ä¸ºã€‚");
                    this.renderMarket();
                } else {
                    state.exp = Math.floor(state.maxExp * 0.5);
                    ui.log("çªç ´å¤±è´¥ï¼æŸå¤±äº†ä¸€åŠä¿®ä¸º...");
                }
            }
            this.updateUI();
        },

        calcOffline() {
            const now = Date.now();
            const diff = Math.floor((now - state.lastSave) / 1000);
            if (diff > 10) {
                const gainGold = diff * this.getIncomeRate();
                state.gold += gainGold;
                let msg = `é—­å…³ ${diff} ç§’ï¼Œè·å¾— ${gainGold} çµçŸ³`;
                if (state.petLvl > 0) {
                    const gainExp = diff * (state.petLvl * 2);
                    state.exp = Math.min(state.maxExp, state.exp + gainExp);
                    msg += `ï¼Œçµå…½é‡‡é›† ${gainExp} ä¿®ä¸º`;
                }
                ui.log(msg + "ã€‚");
            }
        },

        renderMarket() {
            const container = document.getElementById('market-list');
            container.innerHTML = "";
            MARKET_ITEMS.forEach((item, index) => {
                if (item.req && !item.req(state)) return;
                const card = document.createElement('div');
                card.className = 'item-card';
                let cost = item.cost, lvlInfo = "";
                if (item.type === 'upgrade') {
                    cost = Math.floor(item.baseCost * Math.pow(item.costMult, item.getVal(state) - 1));
                    lvlInfo = `<span class="item-lvl">Lv.${item.getVal(state)}</span>`;
                }
                card.innerHTML = `
                    <div><div class="item-head"><span class="item-name">${item.name}</span>${lvlInfo}</div>
                    <div class="item-desc">${item.desc}<br><span style="color:#666">æ•ˆæœ: ${item.effect(state)}</span></div></div>
                    <button class="btn-buy" onclick="game.buy(${index})" ${state.gold < cost ? 'disabled' : ''}>
                        <span>${item.type === 'upgrade'?'å‡çº§':'è´­ä¹°'}</span><span>ğŸ’° ${cost}</span>
                    </button>`;
                container.appendChild(card);
            });
        },

        updateUI() {
            document.getElementById('realm-text').innerText = CONFIG.realms[state.realmIdx] || "å¤©å°Š";
            document.getElementById('gold-text').innerText = Math.floor(state.gold);
            document.getElementById('income-text').innerText = this.getIncomeRate();
            document.getElementById('auto-exp-text').innerText = state.petLvl * 2;
            document.getElementById('click-power').innerText = this.getClickPower();
            document.getElementById('exp-text').innerText = Math.floor(state.exp);
            document.getElementById('max-exp-text').innerText = state.maxExp;
            
            // å€’è®¡æ—¶æ›´æ–° (ä¿®å¤ç‚¹)
            const tEl = document.getElementById('event-timer');
            tEl.innerText = eventTimer;
            tEl.style.color = eventTimer <= 5 ? 'red' : '#aaa'; // å€’è®¡æ—¶å˜çº¢

            let chance = Math.max(0.1, 1.0 - (state.realmIdx * 0.1)) + state.luckBonus;
            document.getElementById('chance-text').innerText = Math.min(100, Math.floor(chance * 100)) + "%";
            const pct = Math.min(100, (state.exp / state.maxExp) * 100);
            document.getElementById('exp-bar').style.width = pct + "%";
            document.getElementById('amulet-status').style.display = state.hasAmulet ? 'block' : 'none';
            
            const btns = document.querySelectorAll('.btn-buy');
            MARKET_ITEMS.forEach((item, idx) => {
                if (btns[idx]) {
                    let cost = item.cost;
                    if(item.type === 'upgrade') cost = Math.floor(item.baseCost * Math.pow(item.costMult, item.getVal(state) - 1));
                    btns[idx].disabled = state.gold < cost;
                }
            });
        },

        save() { state.lastSave = Date.now(); localStorage.setItem('xiuxian_v6', JSON.stringify(state)); },
        load() { const d = localStorage.getItem('xiuxian_v6'); if (d) state = { ...state, ...JSON.parse(d) }; }
    };

    const ui = {
        switchTab(tab, el) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.view-content').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-' + tab).classList.remove('hidden');
        },
        log(msg) {
            const box = document.getElementById('log-container');
            const div = document.createElement('div');
            div.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString('zh-CN',{hour12:false})}]</span> ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        },
        showFloatingText(x, y, text) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.innerText = text;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }
    };

    game.init();
</script>
</body>
</html>