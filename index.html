<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>çµçŸ³ä¿®ä»™ä¼  - ç™¾æ€ä¿®ä»™ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --border-color: #333;
            --text-main: #e0e0e0;
            --gold: #ffd700;
            --blue: #4fc3f7;
            --red: #ff5252;
            --green: #69f0ae;
            --purple: #b388ff;
            --card-bg: #252525;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        .app-container {
            width: 1000px;
            height: 750px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* --- Top Section --- */
        .top-section { display: flex; gap: 15px; flex: 2; min-height: 0; }
        .status-panel { width: 280px; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.3); position: relative; }
        .main-panel { flex: 1; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* --- Tabs --- */
        .nav-tabs { display: flex; background: #111; border-bottom: 1px solid var(--border-color); }
        .nav-item { padding: 15px 25px; cursor: pointer; color: #888; transition: 0.2s; border-right: 1px solid var(--border-color); font-weight: bold; }
        .nav-item:hover { color: #ccc; background: #1a1a1a; }
        .nav-item.active { color: var(--gold); background: var(--panel-bg); border-bottom: 2px solid var(--gold); }

        /* --- Content --- */
        .view-content { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
        .hidden { display: none !important; }

        /* Scene: Spirit Orb */
        .scene-area {
            flex: 1; display: flex; justify-content: center; align-items: center;
            border: 1px dashed #333; border-radius: 8px; margin-bottom: 20px;
            background: radial-gradient(circle at center, #2a2a2a 0%, #1e1e1e 70%);
            position: relative; overflow: hidden;
        }
        .spirit-orb {
            width: 140px; height: 140px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--blue), transparent);
            box-shadow: 0 0 40px var(--blue), inset 0 0 20px #fff;
            animation: breathe 4s infinite ease-in-out;
            display: flex; justify-content: center; align-items: center;
            font-size: 32px; cursor: pointer; transition: transform 0.1s; z-index: 10;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        .spirit-orb:active { transform: scale(0.92); }

        /* Floating Text Animation */
        .floating-text {
            position: absolute; color: var(--green); font-weight: bold; font-size: 20px;
            pointer-events: none; animation: floatUp 1s forwards; text-shadow: 1px 1px 2px black; z-index: 999;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        /* Market Grid */
        .market-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding-bottom: 20px; }
        .item-card {
            background: var(--card-bg); border: 1px solid #333; border-radius: 6px; padding: 12px;
            display: flex; flex-direction: column; justify-content: space-between; min-height: 100px;
        }
        .item-card:hover { border-color: #555; background: #2a2a2a; }
        .item-head { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .item-name { font-weight: bold; color: var(--gold); }
        .item-lvl { font-size: 12px; color: var(--purple); background: #111; padding: 2px 6px; border-radius: 4px; }
        .item-desc { font-size: 12px; color: #888; margin-bottom: 10px; line-height: 1.4; flex: 1; }
        .btn-buy {
            background: #333; border: 1px solid #444; color: #ccc; padding: 8px; border-radius: 4px;
            cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center;
        }
        .btn-buy:hover:not(:disabled) { background: var(--gold); color: #000; border-color: var(--gold); }
        .btn-buy:active:not(:disabled) { transform: scale(0.98); }
        .btn-buy:disabled { opacity: 0.5; cursor: not-allowed; }

        /* General UI */
        .header { font-size: 18px; color: var(--gold); border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; align-items: center; }
        .progress-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--purple)); width: 0%; transition: width 0.2s ease-out; }
        
        .log-panel { flex: 1; background: #111; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; min-height: 0; font-family: 'Consolas', monospace; }
        .log-container { flex: 1; overflow-y: auto; font-size: 13px; line-height: 1.6; }
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .log-time { color: #555; margin-right: 8px; }
        
        /* ä¸åŒçš„æ—¥å¿—é¢œè‰² */
        .log-gain { color: var(--green); }
        .log-loss { color: var(--red); }
        .log-info { color: #aaa; }
        .log-gold { color: var(--gold); }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 0 40px var(--blue); opacity: 0.9; }
            50% { transform: scale(1.05); box-shadow: 0 0 70px var(--purple); opacity: 1; }
        }

        /* Modal */
        #event-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .modal-content {
            background: #252525; width: 450px; padding: 25px;
            border: 1px solid var(--red); box-shadow: 0 0 30px rgba(255, 82, 82, 0.3);
            border-radius: 12px; text-align: center;
        }
        .modal-btn {
            width: 100%; margin-top: 10px; padding: 15px;
            font-size: 16px; background: #333; color: #fff;
            border: 1px solid #555; cursor: pointer; transition: 0.2s;
        }
        .modal-btn:hover { background: #444; border-color: #777; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="top-section">
        <!-- å·¦ä¾§çŠ¶æ€æ  -->
        <div class="status-panel">
            <div class="header">é“å‹é¢æ¿</div>
            <div class="stat-row"><span>å¢ƒç•Œ</span> <span id="realm-text" style="color:var(--purple); font-weight:bold;">å‡¡äºº</span></div>
            <div class="stat-row"><span>çµçŸ³</span> <span style="color:var(--gold); font-weight:bold;"><span id="gold-text">0</span></span></div>
            
            <div style="height:1px; background:#333; margin:10px 0;"></div>
            
            <div class="stat-row" style="color:#aaa;">
                <span>æœºç¼˜å€’è®¡æ—¶</span>
                <span id="event-timer" style="color:var(--red); font-weight:bold;">30</span>
            </div>

            <div class="stat-row" title="æ¥è‡ªèšçµé˜µ"><span>çµçŸ³äº§å‡º</span> <span><span id="income-text">0</span> /ç§’</span></div>
            <div class="stat-row" title="æ¥è‡ªçµå…½"><span>è‡ªåŠ¨ä¿®ä¸º</span> <span><span id="auto-exp-text">0</span> /ç§’</span></div>
            <div class="stat-row" title="æ‰‹åŠ¨ç‚¹å‡»æ”¶ç›Š"><span>æ‰“åæ•ˆç‡</span> <span><span id="click-power">1</span> /æ¬¡</span></div>
            
            <div style="margin-top:auto; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa;">
                    <span>ä¿®ä¸ºè¿›åº¦</span>
                    <span><span id="exp-text">0</span> / <span id="max-exp-text">100</span></span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="exp-bar"></div></div>
            </div>

            <div id="amulet-status" style="font-size:12px; color:var(--green); margin-bottom:10px; display:none; text-align:center;">
                ğŸ›¡ï¸ æŠ¤èº«ç¬¦ç”Ÿæ•ˆä¸­ (å¤±è´¥ä¸æ‰çº§)
            </div>

            <button id="break-btn" onclick="game.attemptBreakthrough()" style="width:100%; padding:12px; background:#223; border:1px solid var(--blue); color:var(--blue); cursor:pointer; border-radius:4px; font-weight:bold;">
                âš¡ å†²å‡»ç“¶é¢ˆ (<span id="chance-text">100%</span>)
            </button>
        </div>

        <!-- å³ä¾§ä¸»ç•Œé¢ -->
        <div class="main-panel">
            <div class="nav-tabs">
                <div class="nav-item active" onclick="ui.switchTab('cave', this)">æ´åºœ</div>
                <div class="nav-item" onclick="ui.switchTab('market', this)">åŠå¸‚</div>
            </div>

            <!-- Tab: æ´åºœ -->
            <div id="view-cave" class="view-content">
                <div class="scene-area" id="scene-area">
                    <div class="spirit-orb" onmousedown="game.manualCultivate(event)">é“</div>
                    <div style="position: absolute; bottom: 20px; font-size: 14px; color: #888;">
                        ç‚¹å‡»ååçµæ°”
                    </div>
                </div>
                <div style="text-align:center; color:#555; font-size:12px; font-style:italic;">
                    â€œä¸‡èˆ¬çš†ä¸‹å“ï¼Œå”¯æœ‰ä¿®ä»™é«˜ã€‚â€
                </div>
            </div>

            <!-- Tab: åŠå¸‚ -->
            <div id="view-market" class="view-content hidden">
                <div class="market-grid" id="market-list"></div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ—¥å¿— -->
    <div class="log-panel">
        <div class="log-container" id="log-container"></div>
    </div>
</div>

<!-- éšæœºäº‹ä»¶å¼¹çª— -->
<div id="event-modal">
    <div class="modal-content">
        <h2 style="color:var(--red); margin-top:0;" id="modal-title">å¥‡é‡</h2>
        <p id="modal-desc" style="color:#ccc; line-height:1.6; margin:20px 0;">å†…å®¹...</p>
        <div id="modal-choices"></div>
    </div>
</div>

<script>
    /* --- 1. é…ç½®ä¸æ•°æ® --- */
    const CONFIG = {
        realms: ["å‡¡äºº", "ç‚¼æ°”åˆæœŸ", "ç‚¼æ°”ä¸­æœŸ", "ç‚¼æ°”åæœŸ", "ç­‘åŸºæœŸ", "é‡‘ä¸¹å¤§é“", "å…ƒå©´è€ç¥–", "åŒ–ç¥å¤©å°Š", "ç‚¼è™šåˆé“", "å¤§ä¹˜æ¸¡åŠ«", "é™†åœ°ç¥ä»™"],
        eventInterval: 30 // 30ç§’ä¸€æ¬¡
    };

    const defaultState = {
        gold: 0,
        exp: 0,
        maxExp: 100,
        realmIdx: 0,
        lastSave: Date.now(),
        incomeLvl: 1, clickLvl: 1, petLvl: 0,
        hasAmulet: false, luckBonus: 0
    };

    let state = { ...defaultState };
    let eventTimer = CONFIG.eventInterval;

    /* --- 2. æ‰©å……çš„éšæœºäº‹ä»¶åº“ (15+ ä¸ªäº‹ä»¶) --- */
    // Helper: æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤ŸçµçŸ³
    const checkGold = (val) => state.gold >= val;
    
    const EVENTS = [
        // --- åŸºç¡€ç¦åˆ©ç±» ---
        {
            t: "è·¯é‡ä¹ä¸",
            d: "ä¸€ä¸ªç–¯ç–¯ç™«ç™«çš„è€å¤´æ‹¦ä½ä½ ï¼Œéè¦é€ä½ ä¸€æœ¬ç ´ä¹¦ã€‚",
            opts: [
                { txt: "æ”¶ä¸‹çœ‹çœ‹", act: (g) => { g.addExp(100); return {msg:"ç ´ä¹¦ç«Ÿæ˜¯æ®‹ç¼ºå¿ƒæ³•ï¼Œä¿®ä¸º+100ï¼", cls:"log-gain"}; } },
                { txt: "å«Œè„èµ°å¼€", act: (g) => { return {msg:"ä½ é”™è¿‡äº†æœºç¼˜ã€‚", cls:"log-info"}; } }
            ]
        },
        {
            t: "å¤©é™æ¨ªè´¢",
            d: "ä½ åœ¨åå±±è¢«çŸ³å¤´ç»Šå€’ï¼ŒæŒ–å¼€ä¸€çœ‹...",
            opts: [
                { txt: "æŒ–å¼€", act: (g) => { state.gold+=100; return {msg:"ç«Ÿæ˜¯ä¸€å—ä¸‹å“çµçŸ³ï¼çµçŸ³+100", cls:"log-gold"}; } }
            ]
        },
        
        // --- èµŒåš/äº¤æ˜“ç±» ---
        {
            t: "èµŒçŸ³å¤§ä¼š",
            d: "åŠå¸‚æ­£åœ¨ä¸¾åŠèµŒçŸ³ï¼Œæ¯å—åŸçŸ³å”®ä»· 200 çµçŸ³ã€‚",
            opts: [
                { txt: "ä¹°ä¸€å— (200çµçŸ³)", act: (g) => { 
                    if(!checkGold(200)) return {msg:"çµçŸ³ä¸è¶³ï¼", cls:"log-loss"};
                    state.gold -= 200;
                    const rnd = Math.random();
                    if(rnd > 0.8) { state.gold += 1000; return {msg:"åˆ‡å‡ºäº†æå“ç‰é«“ï¼çµçŸ³+1000", cls:"log-gold"}; }
                    if(rnd > 0.5) { state.gold += 300; return {msg:"åˆ‡å‡ºäº†æ™®é€šçµç‰ã€‚çµçŸ³+300", cls:"log-gold"}; }
                    return {msg:"å…¨æ˜¯åºŸæ–™ï¼Œè¡€æœ¬æ— å½’ã€‚", cls:"log-loss"};
                }},
                { txt: "çœ‹çœ‹å°±å¥½", act: (g) => { return {msg:"ä½ å¿ä½äº†è¯±æƒ‘ã€‚", cls:"log-info"}; } }
            ]
        },
        {
            t: "é»‘å¸‚ç›²ç›’",
            d: "ç¥ç§˜å•†äººå…œå”®ä¸‰ä¸ªé”¦å›Šï¼Œå”®ä»· 100 çµçŸ³ï¼Œå£°ç§°å…¶ä¸­æœ‰å¤§é€ åŒ–ã€‚",
            opts: [
                { txt: "ä¹°çº¢è‰²é”¦å›Š", act: (g) => { 
                     if(!checkGold(100)) return {msg:"ç©·é¬¼ï¼Œæ»šï¼", cls:"log-loss"};
                     state.gold -= 100; g.addExp(300); return {msg:"é‡Œé¢æ˜¯ç²¾çº¯å¦–ä¸¹ï¼ä¿®ä¸º+300", cls:"log-gain"};
                }},
                { txt: "ä¹°é»‘è‰²é”¦å›Š", act: (g) => { 
                     if(!checkGold(100)) return {msg:"ç©·é¬¼ï¼Œæ»šï¼", cls:"log-loss"};
                     state.gold -= 100; return {msg:"é‡Œé¢æ˜¯ä¸€å¼ å˜²è®½ä½ çš„çº¸æ¡ã€‚", cls:"log-loss"};
                }},
                { txt: "ä¸ä¹°", act: (g) => { return {msg:"ä½ æ²¡ç†ä¼šå•†äººçš„æ¨é”€ã€‚", cls:"log-info"}; } }
            ]
        },

        // --- æˆ˜æ–—/å¢ƒç•Œåˆ¤å®šç±» ---
        {
            t: "æ‹¦è·¯æŠ¢åŠ«",
            d: "ä¸€ä¼™å¼ºç›—æ‹¦ä½å»è·¯ï¼Œé¢†å¤´çš„æ˜¯ä¸ªç»ƒæ°”åæœŸçš„ä¿®å£«ã€‚",
            opts: [
                { txt: "äº¤å‡º50çµçŸ³ä¹°è·¯", act: (g) => { 
                    if(state.gold>=50) {state.gold-=50; return {msg:"ç ´è´¢å…ç¾ã€‚", cls:"log-info"};}
                    else return {msg:"ä½ æ²¡é’±ï¼Œè¢«æ‰“äº†ä¸€é¡¿ã€‚", cls:"log-loss"};
                }},
                { txt: "åå‡» (éœ€ç­‘åŸºæœŸä»¥ä¸Š)", act: (g) => { 
                    if(state.realmIdx >= 4) { // ç­‘åŸºæœŸç´¢å¼•
                        state.gold += 200; return {msg:"ä½ éšæ‰‹ä¸€æŒ¥ä¾¿å‡»æºƒäº†å¼ºç›—ï¼Œç¼´è·çµçŸ³+200", cls:"log-gold"}; 
                    } else {
                        g.addExp(-100); return {msg:"ä½ å¢ƒç•Œä½å¾®ï¼Œè¢«å¼ºç›—æš´æ‰“ï¼Œä¿®ä¸ºå—æŸã€‚", cls:"log-loss"}; 
                    }
                }}
            ]
        },
        {
            t: "å®—é—¨å¤§æ¯”",
            d: "é™„è¿‘å®—é—¨ä¸¾åŠæ¯”æ­¦æ‹›äº²ï¼Œä½ ä¹Ÿå»å‡‘çƒ­é—¹ã€‚",
            opts: [
                { txt: "ä¸Šå°æŒ‘æˆ˜", act: (g) => {
                    const winChance = 0.3 + (state.realmIdx * 0.1);
                    if(Math.random() < winChance) {
                        g.addExp(500); return {msg:"æŠ€æƒŠå››åº§ï¼è·å¾—å®—é—¨èµè¯†ã€‚ä¿®ä¸º+500", cls:"log-gain"};
                    } else {
                        g.addExp(-50); return {msg:"è¢«äººä¸€è„šè¸¹ä¸‹æ“‚å°ï¼Œä¸¢äººç°çœ¼ã€‚ä¿®ä¸º-50", cls:"log-loss"};
                    }
                }},
                { txt: "åƒç“œå›´è§‚", act: (g) => { g.addExp(20); return {msg:"è§‚æ‘©é«˜æ‰‹è¿‡æ‹›ï¼Œç•¥æœ‰æ‰€æ‚Ÿã€‚ä¿®ä¸º+20", cls:"log-gain"}; } }
            ]
        },

        // --- é“å¾·/æŠ‰æ‹©ç±» ---
        {
            t: "é‡ä¼¤çš„çµç‹",
            d: "è‰ä¸›ä¸­æœ‰ä¸€åªå—ä¼¤çš„çµç‹ï¼Œçœ‹èµ·æ¥å¥„å¥„ä¸€æ¯ã€‚",
            opts: [
                { txt: "è€—è´¹çµçŸ³æ•‘æ²» (-50çµçŸ³)", act: (g) => {
                    if(!checkGold(50)) return {msg:"ä½ æœ‰å¿ƒæ— åŠ›ã€‚", cls:"log-info"};
                    state.gold -= 50;
                    if(Math.random() > 0.3) {
                         state.petLvl++; return {msg:"çµç‹ä¸ºäº†æŠ¥æ©ï¼Œå†³å®šè¿½éšä½ ï¼(çµå…½ç­‰çº§+1)", cls:"log-gain"};
                    }
                    return {msg:"çµç‹ä¼¤å¥½åè·‘äº†ï¼Œç•™ä¸‹å‡ æ ¹çµæ¯›ã€‚", cls:"log-info"};
                }},
                { txt: "å‰¥çš®å–é’±", act: (g) => {
                    state.gold += 80; return {msg:"è™½ç„¶æ®‹å¿ï¼Œä½†çš®æ¯›å–äº†80çµçŸ³ã€‚", cls:"log-gold"};
                }}
            ]
        },
        {
            t: "å¤ä¿®é—åºœ",
            d: "å‘ç°ä¸€åº§ä¸Šå¤æ´åºœï¼Œé—¨å£ç¦åˆ¶é—ªçƒã€‚",
            opts: [
                { txt: "å¼ºè¡Œç ´é˜µ (é«˜é£é™©)", act: (g) => {
                    if(Math.random() > 0.6) {
                        state.gold += 500; g.addExp(500); return {msg:"å¯Œè´µé™©ä¸­æ±‚ï¼è·å¾—å¤§é‡å®ç‰©ï¼", cls:"log-gold"};
                    } else {
                        g.addExp(-200); return {msg:"ç¦åˆ¶åå™¬ï¼ä½ è¢«ç‚¸å¾—ç°å¤´åœŸè„¸ã€‚ä¿®ä¸º-200", cls:"log-loss"};
                    }
                }},
                { txt: "åœ¨å¤–å›´æ¡æ¼", act: (g) => {
                    state.gold += 50; return {msg:"æ¡åˆ°ä¸€äº›æ®‹ç¾¹å†·ç‚™ã€‚çµçŸ³+50", cls:"log-gold"};
                }}
            ]
        },

        // --- ä¿®ç‚¼å¼‚è±¡ç±» ---
        {
            t: "å¿ƒé­”å…¥ä¾µ",
            d: "ä¿®ç‚¼æ—¶å¿ƒç¥ä¸å®ï¼Œä¼¼ä¹æœ‰å¤©é­”ä¹±èˆã€‚",
            opts: [
                { txt: "ç´§å®ˆé“å¿ƒ (50%æ¦‚ç‡)", act: (g) => {
                    if(Math.random() > 0.5) {
                        g.addExp(300); return {msg:"æˆ˜èƒœå¿ƒé­”ï¼Œé“å¿ƒæ›´åŠ ç¨³å›ºï¼ä¿®ä¸º+300", cls:"log-gain"};
                    } else {
                        g.addExp(-100); return {msg:"å¿ƒç¥å¤±å®ˆï¼Œåå‡ºä¸€å£é²œè¡€ã€‚ä¿®ä¸º-100", cls:"log-loss"};
                    }
                }},
                { txt: "ç«‹åˆ»å‡ºå…³", act: (g) => { return {msg:"è™½ç„¶ä¸­æ–­äº†ä¿®ç‚¼ï¼Œä½†ä¿ä½äº†å¹³å®‰ã€‚", cls:"log-info"}; } }
            ]
        },
        {
            t: "å¤©é“é¡¿æ‚Ÿ",
            d: "è§‚çœ‹äº‘å·äº‘èˆ’ï¼Œå¿½æœ‰æ‰€æ„Ÿï¼Œè¿›å…¥é¡¿æ‚ŸçŠ¶æ€ã€‚",
            opts: [
                { txt: "é¡ºå…¶è‡ªç„¶", act: (g) => {
                     const gain = 200 * (state.realmIdx + 1);
                     g.addExp(gain); return {msg:`é¡¿æ‚Ÿè‰¯ä¹…ï¼Œä¿®ä¸ºå¤§æ¶¨ï¼ä¿®ä¸º+${gain}`, cls:"log-gain"};
                }}
            ]
        }
    ];

    /* --- 3. åŠå¸‚å•†å“å®šä¹‰ --- */
    const MARKET_ITEMS = [
        {
            id: 'income', name: 'ğŸ’ èšçµé˜µæ³•', type: 'upgrade',
            desc: 'å‡çº§æ´åºœçµè„‰ï¼Œå¢åŠ çµçŸ³è‡ªåŠ¨äº§å‡ºã€‚',
            baseCost: 50, costMult: 1.5,
            getVal: (s) => s.incomeLvl,
            effect: (s) => `äº§å‡º +1/s`,
            action: (s) => { s.incomeLvl++; return "èšçµé˜µå‡çº§ï¼çµæ°”æ›´åŠ æµ“éƒäº†ã€‚"; }
        },
        {
            id: 'click', name: 'ğŸ“– åçº³å¿ƒæ³•', type: 'upgrade',
            desc: 'æ”¹è‰¯å‘¼å¸æ³•é—¨ï¼Œæå‡æ¯æ¬¡æ‰“åçš„ä¿®ä¸ºã€‚',
            baseCost: 100, costMult: 1.6,
            getVal: (s) => s.clickLvl,
            effect: (s) => `ç‚¹å‡» +2`,
            action: (s) => { s.clickLvl++; return "å¿ƒæ³•ç²¾è¿›ï¼æ‰“åæ•ˆç‡æå‡ã€‚"; }
        },
        {
            id: 'pet', name: 'ğŸ¦Š é¥²å…»çµå…½', type: 'upgrade',
            desc: 'é©¯å…»ä¸€åªçµç‹ï¼Œå®ƒä¼šå¸®ä½ è‡ªåŠ¨ä¿®ç‚¼ã€‚',
            baseCost: 1000, costMult: 1.8,
            getVal: (s) => s.petLvl,
            effect: (s) => `è‡ªåŠ¨ä¿®ä¸º +${(s.petLvl+1)*2}/s`,
            action: (s) => { s.petLvl++; return "çµå…½æˆé•¿äº†ï¼å®ƒå¼€å§‹å¸®ä½ èšé›†ä¿®ä¸ºã€‚"; }
        },
        {
            id: 'pill_s', name: 'ğŸ’Š èšæ°”æ•£', type: 'con',
            desc: 'ç‚¼æ°”æœŸä¿®å£«å¸¸ç”¨çš„ä¸¹è¯ï¼Œæœç”¨å¯å¢è¿›ä¿®ä¸ºã€‚',
            cost: 20,
            effect: () => `ä¿®ä¸º +50`,
            action: (s) => { game.addExp(50); return "æœç”¨èšæ°”æ•£ï¼Œæš–æµæ¶Œéå…¨èº«ã€‚"; }
        },
        {
            id: 'luck', name: 'ğŸ€ æ°”è¿é‡‘é¾™', type: 'con',
            desc: 'è´­ä¹°ä¸€æ¬¡æ€§çš„å¤©é“æ°”è¿ï¼Œæå‡ä¸‹æ¬¡çªç ´æˆåŠŸç‡ã€‚',
            cost: 300,
            effect: () => `æˆåŠŸç‡ +5%`,
            action: (s) => { s.luckBonus += 0.05; return "æ°”è¿åŠ èº«ï¼ä¸‹æ¬¡çªç ´å¦‚æœ‰ç¥åŠ©ã€‚"; }
        },
        {
            id: 'amulet', name: 'ğŸ›¡ï¸ æ›¿èº«è‰äºº', type: 'unique',
            desc: 'çè´µçš„æ›¿èº«æ³•å®ã€‚æŠµæŒ¡ä¸€æ¬¡çªç ´å¤±è´¥çš„æƒ©ç½šã€‚',
            cost: 500,
            req: (s) => !s.hasAmulet,
            effect: () => `ä¿å‘½ä¸€æ¬¡`,
            action: (s) => { s.hasAmulet = true; return "è£…å¤‡æ›¿èº«è‰äººï¼å¿ƒé‡Œè¸å®å¤šäº†ã€‚"; }
        }
    ];

    /* --- 4. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ --- */
    const game = {
        init() {
            this.load();
            this.calcOffline();
            this.renderMarket();
            this.updateUI();
            
            setInterval(() => this.tick(), 1000);
            setInterval(() => this.save(), 10000);
            
            ui.log("é“å‹è¯·äº†ï¼ç‚¹å‡»çµçƒä¿®ç‚¼ï¼Œå·¦ä¾§å…³æ³¨æœºç¼˜å€’è®¡æ—¶ã€‚");
        },

        tick() {
            const income = this.getIncomeRate();
            state.gold += income;
            if (state.petLvl > 0) this.addExp(state.petLvl * 2);

            eventTimer--;
            if(eventTimer <= 0) {
                this.triggerEvent();
                eventTimer = CONFIG.eventInterval;
            }
            this.updateUI();
        },

        triggerEvent() {
            const evt = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            const modal = document.getElementById('event-modal');
            const choices = document.getElementById('modal-choices');
            
            document.getElementById('modal-title').innerText = evt.t;
            document.getElementById('modal-desc').innerText = evt.d;
            choices.innerHTML = "";

            evt.opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'modal-btn';
                btn.innerText = opt.txt;
                btn.onclick = () => {
                    const res = opt.act(this);
                    // å¦‚æœç»“æœæ˜¯å¯¹è±¡ï¼Œè§£æ„å‡ºæ¶ˆæ¯å’Œæ ·å¼
                    if (typeof res === 'object' && res.msg) {
                        ui.log(res.msg, res.cls);
                        if(res.msg !== "çµçŸ³ä¸è¶³ï¼" && res.msg !== "ç©·é¬¼ï¼Œæ»šï¼") modal.style.display = "none";
                    } else {
                        // å…¼å®¹æ—§æ ¼å¼
                        ui.log(res); 
                        modal.style.display = "none";
                    }
                    this.updateUI();
                };
                choices.appendChild(btn);
            });
            modal.style.display = "flex";
        },

        getClickPower() { return 1 + Math.floor(state.realmIdx * 1.5) + (state.clickLvl - 1) * 2; },
        getIncomeRate() { return 1 + Math.floor((state.incomeLvl - 1) * 1.5); },

        manualCultivate(e) {
            const gain = this.getClickPower();
            this.addExp(gain);
            
            let x, y;
            if (e) { x = e.clientX; y = e.clientY; } 
            else {
                const rect = document.getElementById('scene-area').getBoundingClientRect();
                x = rect.left + rect.width / 2; y = rect.top + rect.height / 2;
            }
            ui.showFloatingText(x, y, `+${gain} ä¿®ä¸º`);
        },

        addExp(val) {
            if (state.exp >= state.maxExp) return;
            state.exp += val;
            if (state.exp > state.maxExp) state.exp = state.maxExp;
            this.updateUI();
        },

        buy(itemIndex) {
            const item = MARKET_ITEMS[itemIndex];
            let cost = item.cost;
            if (item.type === 'upgrade') cost = Math.floor(item.baseCost * Math.pow(item.costMult, item.getVal(state) - 1));

            if (state.gold >= cost) {
                state.gold -= cost;
                const msg = item.action(state);
                ui.log(msg, "log-gold");
                this.renderMarket();
                this.updateUI();
            } else {
                ui.log("çµçŸ³ä¸è¶³ï¼æ— æ³•è´­ä¹° " + item.name, "log-loss");
            }
        },

        attemptBreakthrough() {
            if (state.exp < state.maxExp) { ui.log("ä¿®ä¸ºæœªæ»¡ï¼Œæ— æ³•æ„Ÿåº”å¤©åŠ«ã€‚", "log-info"); return; }
            let chance = Math.max(0.1, 1.0 - (state.realmIdx * 0.1)) + state.luckBonus;
            
            if (Math.random() < chance) {
                state.realmIdx++;
                state.exp = 0;
                state.maxExp = Math.floor(state.maxExp * 2.5);
                state.luckBonus = 0;
                ui.log(`=== æ¸¡åŠ«æˆåŠŸï¼æ™‹å‡ [${CONFIG.realms[state.realmIdx]}] ===`, "log-gold");
            } else {
                state.luckBonus = 0;
                if (state.hasAmulet) {
                    state.hasAmulet = false;
                    ui.log("çªç ´å¤±è´¥ï¼æ›¿èº«è‰äººç‚¸è£‚ï¼Œä¿ä½äº†ä¿®ä¸ºã€‚", "log-gain");
                    this.renderMarket();
                } else {
                    state.exp = Math.floor(state.maxExp * 0.5);
                    ui.log("çªç ´å¤±è´¥ï¼æŸå¤±äº†ä¸€åŠä¿®ä¸º...", "log-loss");
                }
            }
            this.updateUI();
        },

        calcOffline() {
            const now = Date.now();
            const diff = Math.floor((now - state.lastSave) / 1000);
            if (diff > 10) {
                const gainGold = diff * this.getIncomeRate();
                state.gold += gainGold;
                let msg = `é—­å…³ ${diff} ç§’ï¼Œè·å¾— ${gainGold} çµçŸ³`;
                if (state.petLvl > 0) {
                    const gainExp = diff * (state.petLvl * 2);
                    state.exp = Math.min(state.maxExp, state.exp + gainExp);
                    msg += `ï¼Œçµå…½é‡‡é›† ${gainExp} ä¿®ä¸º`;
                }
                ui.log(msg + "ã€‚", "log-info");
            }
        },

        renderMarket() {
            const container = document.getElementById('market-list');
            container.innerHTML = "";
            MARKET_ITEMS.forEach((item, index) => {
                if (item.req && !item.req(state)) return;
                const card = document.createElement('div');
                card.className = 'item-card';
                let cost = item.cost, lvlInfo = "";
                if (item.type === 'upgrade') {
                    cost = Math.floor(item.baseCost * Math.pow(item.costMult, item.getVal(state) - 1));
                    lvlInfo = `<span class="item-lvl">Lv.${item.getVal(state)}</span>`;
                }
                card.innerHTML = `
                    <div><div class="item-head"><span class="item-name">${item.name}</span>${lvlInfo}</div>
                    <div class="item-desc">${item.desc}<br><span style="color:#666">æ•ˆæœ: ${item.effect(state)}</span></div></div>
                    <button class="btn-buy" onclick="game.buy(${index})" ${state.gold < cost ? 'disabled' : ''}>
                        <span>${item.type === 'upgrade'?'å‡çº§':'è´­ä¹°'}</span><span>ğŸ’° ${cost}</span>
                    </button>`;
                container.appendChild(card);
            });
        },

        updateUI() {
            document.getElementById('realm-text').innerText = CONFIG.realms[state.realmIdx] || "å¤©å°Š";
            document.getElementById('gold-text').innerText = Math.floor(state.gold);
            document.getElementById('income-text').innerText = this.getIncomeRate();
            document.getElementById('auto-exp-text').innerText = state.petLvl * 2;
            document.getElementById('click-power').innerText = this.getClickPower();
            document.getElementById('exp-text').innerText = Math.floor(state.exp);
            document.getElementById('max-exp-text').innerText = state.maxExp;
            
            const tEl = document.getElementById('event-timer');
            tEl.innerText = eventTimer;
            tEl.style.color = eventTimer <= 5 ? 'red' : '#aaa';

            let chance = Math.max(0.1, 1.0 - (state.realmIdx * 0.1)) + state.luckBonus;
            document.getElementById('chance-text').innerText = Math.min(100, Math.floor(chance * 100)) + "%";
            const pct = Math.min(100, (state.exp / state.maxExp) * 100);
            document.getElementById('exp-bar').style.width = pct + "%";
            document.getElementById('amulet-status').style.display = state.hasAmulet ? 'block' : 'none';
            
            const btns = document.querySelectorAll('.btn-buy');
            MARKET_ITEMS.forEach((item, idx) => {
                if (btns[idx]) {
                    let cost = item.cost;
                    if(item.type === 'upgrade') cost = Math.floor(item.baseCost * Math.pow(item.costMult, item.getVal(state) - 1));
                    btns[idx].disabled = state.gold < cost;
                }
            });
        },

        save() { state.lastSave = Date.now(); localStorage.setItem('xiuxian_v7', JSON.stringify(state)); },
        load() { const d = localStorage.getItem('xiuxian_v7'); if (d) state = { ...state, ...JSON.parse(d) }; }
    };

    const ui = {
        switchTab(tab, el) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.view-content').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-' + tab).classList.remove('hidden');
        },
        log(msg, cls) {
            const box = document.getElementById('log-container');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('zh-CN',{hour12:false});
            div.innerHTML = `<span class="log-time">[${time}]</span> <span class="${cls || ''}">${msg}</span>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        },
        showFloatingText(x, y, text) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.innerText = text;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }
    };

    game.init();
</script>
</body>
</html>