<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>çµçŸ³ä¿®ä»™ä¼  - é£å‰‘é™ä¸–ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --border-color: #333;
            --text-main: #e0e0e0;
            --gold: #ffd700;
            --blue: #4fc3f7;
            --red: #ff5252;
            --green: #69f0ae;
            --purple: #b388ff;
            --card-bg: #252525;
            --danger: #d32f2f;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        .app-container { width: 1000px; height: 750px; display: flex; flex-direction: column; gap: 15px; }

        /* --- Top Section --- */
        .top-section { display: flex; gap: 15px; flex: 2; min-height: 0; }
        .status-panel { width: 280px; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.3); position: relative; }
        .main-panel { flex: 1; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* --- Tabs --- */
        .nav-tabs { display: flex; background: #111; border-bottom: 1px solid var(--border-color); }
        .nav-item { flex: 1; text-align: center; padding: 15px 0; cursor: pointer; color: #888; transition: 0.2s; border-right: 1px solid var(--border-color); font-weight: bold; font-size: 16px; }
        .nav-item:hover { color: #ccc; background: #1a1a1a; }
        .nav-item.active { color: var(--gold); background: var(--panel-bg); border-bottom: 3px solid var(--gold); }

        /* --- Views --- */
        .view-content { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
        .hidden { display: none !important; }

        /* View 1: Home (Cultivate) */
        .home-scene {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #2a2a2a 0%, #1e1e1e 80%);
            border-radius: 8px; border: 1px solid #333; position: relative;
        }
        .spirit-orb {
            width: 160px; height: 160px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--blue), transparent);
            box-shadow: 0 0 50px var(--blue), inset 0 0 20px #fff;
            animation: breathe 4s infinite ease-in-out;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; cursor: pointer; transition: transform 0.1s; z-index: 10;
            text-shadow: 0 0 10px rgba(255,255,255,0.5); user-select: none;
        }
        .spirit-orb:active { transform: scale(0.95); }
        
        /* View 2: Map Cards */
        .current-map-banner {
            padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #444;
            background-size: cover; transition: 0.3s; display: flex; justify-content: space-between; align-items: center;
        }
        .bg-map-0 { background: linear-gradient(45deg, #1e1e1e, #2a2a2a); border-left: 4px solid #888; }
        .bg-map-1 { background: linear-gradient(45deg, #1a2a1a, #0d1a0d); border-left: 4px solid var(--green); }
        .bg-map-2 { background: linear-gradient(45deg, #2a1a1a, #1a0d0d); border-left: 4px solid var(--red); }
        .bg-map-3 { background: linear-gradient(45deg, #1a1a2a, #000); border-left: 4px solid var(--purple); }

        .map-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .map-card {
            background: #252525; border: 1px solid #444; padding: 15px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
        }
        .map-card:hover { border-color: #666; background: #2a2a2a; }
        .map-info h3 { margin: 0 0 5px 0; font-size: 16px; color: var(--gold); }
        .map-btn { padding: 8px 16px; border-radius: 4px; border: 1px solid #555; background: #333; color: #ccc; cursor: pointer; }
        .map-btn:hover { background: var(--blue); color: #000; border-color: var(--blue); }
        .map-btn.active { background: var(--green); color: #000; border-color: var(--green); cursor: default; }
        .map-btn.locked { opacity: 0.5; cursor: not-allowed; background: #222; }

        /* Inventory Styles */
        .item-slot {
            background: #252525; border: 1px solid #444; padding: 12px; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            transition: all 0.2s; margin-bottom: 8px;
        }
        .item-slot:hover { border-color: var(--gold); background: #333; transform: translateX(5px); }
        .quality-common { color: #ccc; }
        .quality-rare { color: var(--blue); }
        .quality-epic { color: var(--purple); }
        .quality-legendary { color: var(--gold); text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }

        /* Market & General */
        .market-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .item-card { background: var(--card-bg); border: 1px solid #333; border-radius: 6px; padding: 12px; display: flex; flex-direction: column; justify-content: space-between; min-height: 100px; }
        .item-card:hover { border-color: #555; background: #2a2a2a; }
        .btn-buy { background: #333; border: 1px solid #444; color: #ccc; padding: 8px; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; }
        .btn-buy:hover:not(:disabled) { background: var(--gold); color: #000; }
        .btn-buy:disabled { opacity: 0.5; cursor: not-allowed; }

        .log-panel { flex: 1; background: #111; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; min-height: 0; font-family: 'Consolas', monospace; }
        .log-container { flex: 1; overflow-y: auto; font-size: 13px; line-height: 1.6; }
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        
        .header { font-size: 18px; color: var(--gold); border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; align-items: center; }
        .progress-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--purple)); width: 0%; transition: width 0.2s ease-out; }
        
        .floating-text { position: absolute; color: var(--green); font-weight: bold; font-size: 24px; pointer-events: none; animation: floatUp 0.8s forwards; text-shadow: 1px 1px 2px black; z-index: 100; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.3); } }
        @keyframes breathe { 0%, 100% { transform: scale(1); box-shadow: 0 0 50px var(--blue); opacity: 0.9; } 50% { transform: scale(1.05); box-shadow: 0 0 80px var(--purple); opacity: 1; } }

        /* Colors */
        .c-danger { color: var(--red); } .c-safe { color: var(--green); } .c-gold { color: var(--gold); } .c-exp { color: var(--blue); }

        /* Modal */
        #event-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: #252525; width: 450px; padding: 25px; border: 1px solid var(--red); box-shadow: 0 0 30px rgba(255, 82, 82, 0.3); border-radius: 12px; text-align: center; }
        .modal-btn { width: 100%; margin-top: 10px; padding: 15px; font-size: 16px; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; transition: 0.2s; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="top-section">
        <div class="status-panel">
            <div class="header">é“å‹é¢æ¿</div>
            <div class="stat-row"><span>å¢ƒç•Œ</span> <span id="realm-text" style="color:var(--purple); font-weight:bold;">å‡¡äºº</span></div>
            <div class="stat-row"><span>çµçŸ³</span> <span class="c-gold" style="font-weight:bold;"><span id="gold-text">0</span></span></div>
            
            <div style="height:1px; background:#333; margin:10px 0;"></div>
            
            <div class="stat-row"><span>å½“å‰ä½ç½®</span> <span id="location-text" style="color:var(--blue)">é—­å…³æ´åºœ</span></div>
            <div class="stat-row" title="å¢ƒç•Œ+å¿ƒæ³•+è£…å¤‡"><span>æˆ˜æ–—åŠ›</span> <span id="power-text" style="color:var(--red); font-weight:bold;">1</span></div>

            <div style="margin-top:10px; font-size:12px; color:#aaa;">
                <div class="stat-row"><span>èšçµäº§å‡º</span> <span><span id="income-text">0</span> /s</span></div>
                <div class="stat-row"><span>åœ°å›¾åŠ æˆ</span> <span id="map-mult-text" class="c-safe">x1.0</span></div>
            </div>
            
            <div style="margin-top:auto; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa;">
                    <span>ä¿®ä¸ºè¿›åº¦</span>
                    <span><span id="exp-text">0</span> / <span id="max-exp-text">100</span></span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="exp-bar"></div></div>
            </div>

            <div id="amulet-status" style="font-size:12px; color:var(--green); margin-bottom:10px; display:none; text-align:center;">
                ğŸ›¡ï¸ æŠ¤èº«ç¬¦ç”Ÿæ•ˆä¸­
            </div>

            <button onclick="game.attemptBreakthrough()" style="width:100%; padding:12px; background:#223; border:1px solid var(--blue); color:var(--blue); cursor:pointer; border-radius:4px; font-weight:bold;">
                âš¡ å†²å‡»ç“¶é¢ˆ (<span id="chance-text">100%</span>)
            </button>
        </div>

        <div class="main-panel">
            <div class="nav-tabs">
                <div class="nav-item active" onclick="ui.switchTab('home', this)">ä¿®ç‚¼</div>
                <div class="nav-item" onclick="ui.switchTab('map', this)">å†ç»ƒ</div>
                <div class="nav-item" onclick="ui.switchTab('inventory', this)">èƒŒåŒ…</div>
                <div class="nav-item" onclick="ui.switchTab('market', this)">åŠå¸‚</div>
            </div>

            <div id="view-home" class="view-content">
                <div style="text-align:center; color:#888; margin-bottom:10px; font-size:13px;">
                    â€œä¸‡èˆ¬çš†ä¸‹å“ï¼Œå”¯æœ‰ä¿®ä»™é«˜ã€‚â€<br>
                    <span style="font-size:12px; color:#666">ç‚¹å‡»çµçƒï¼Œååå¤©åœ°çµæ°”</span>
                </div>
                
                <div class="home-scene">
                    <div style="position:absolute; top:10px; left:10px; font-size:12px; color:rgba(255,255,255,0.5);">
                        æœºç¼˜å€’è®¡æ—¶: <span id="event-timer" style="color:var(--red)">30</span>s
                    </div>
                    
                    <div class="spirit-orb" onmousedown="game.manualCultivate(event)">é“</div>
                    
                    <div style="margin-top:40px; color:#555; font-size:12px;">
                        æ¯æ¬¡æ‰“åè·å¾— <span id="click-val-disp" style="color:var(--green)">1</span> ç‚¹ä¿®ä¸º
                    </div>
                </div>
            </div>

            <div id="view-map" class="view-content hidden">
                <div id="cur-map-banner" class="current-map-banner bg-map-0">
                    <div>
                        <div style="font-size:12px; color:#ccc;">æ­£åœ¨æ¸¸å†</div>
                        <div style="font-size:18px; font-weight:bold; color:#fff;" id="banner-loc-name">é—­å…³æ´åºœ</div>
                    </div>
                    <div style="text-align:right; font-size:12px; color:#ddd;">
                        <div id="banner-risk-text">å®‰å…¨åŒºåŸŸ</div>
                        <div id="banner-bonus-text">æ”¶ç›Š x1.0</div>
                    </div>
                </div>

                <h4 style="margin:0 0 10px 0; color:#888; border-bottom:1px solid #333; padding-bottom:5px;">é€‰æ‹©å†ç»ƒåœ°ç‚¹</h4>
                <div class="map-grid" id="map-list"></div>
                
                <div style="margin-top:20px; font-size:12px; color:#666; line-height:1.5;">
                    <span style="color:var(--red)">*æ³¨æ„*</span>ï¼šè‹¥æˆ˜åŠ›ä¸è¶³å¼ºè¡Œè¿›å…¥å±é™©åŒºåŸŸï¼Œä¼šé­é‡å¦–å…½è¢­å‡»å¹¶è¢«å¼ºåˆ¶é€å›ï¼Œä¸”æŸå¤±çµçŸ³ã€‚å±é™©åŒºåŸŸæœ‰æœºä¼šæ‰è½<span style="color:var(--purple)">è£…å¤‡</span>ã€‚
                </div>
            </div>

            <div id="view-inventory" class="view-content hidden">
                <div style="background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; margin-bottom: 20px;">
                    <div style="font-size:12px; color:#aaa; margin-bottom:5px;">å½“å‰è£…å¤‡</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-size:16px; font-weight:bold;" id="equipped-weapon-name">æ— </div>
                        <div style="color:var(--red); font-weight:bold;" id="equipped-weapon-power"></div>
                    </div>
                </div>

                <div class="header">å‚¨ç‰©è¢‹ <span style="font-size:12px; color:#666; font-weight:normal;">(ç‚¹å‡»ç©¿æˆ´)</span></div>
                <div id="inventory-list">
                    <div style="text-align:center; color:#555; margin-top:50px;">ç©ºç©ºå¦‚ä¹Ÿ</div>
                </div>
            </div>

            <div id="view-market" class="view-content hidden">
                <div class="market-grid" id="market-list"></div>
            </div>
        </div>
    </div>

    <div class="log-panel">
        <div class="log-container" id="log-container"></div>
    </div>
</div>

<div id="event-modal">
    <div class="modal-content">
        <h2 style="color:var(--red); margin-top:0;" id="modal-title">å¥‡é‡</h2>
        <p id="modal-desc" style="color:#ccc; line-height:1.6; margin:20px 0;"></p>
        <div id="modal-choices"></div>
    </div>
</div>

<script>
    /* --- 1. é…ç½®ä¸æ•°æ® --- */
    const CONFIG = {
        realms: ["å‡¡äºº", "ç‚¼æ°”åˆæœŸ", "ç‚¼æ°”ä¸­æœŸ", "ç‚¼æ°”åæœŸ", "ç­‘åŸºæœŸ", "é‡‘ä¸¹å¤§é“", "å…ƒå©´è€ç¥–", "åŒ–ç¥å¤©å°Š", "ç‚¼è™šåˆé“", "å¤§ä¹˜æ¸¡åŠ«"],
        eventInterval: 30
    };

    const MAPS = [
        { id: 0, name: "é—­å…³æ´åºœ", req: 0, desc: "ç»å¯¹å®‰å…¨ä¹‹åœ°ã€‚", goldMult: 1.0, autoExp: 0, risk: 0 },
        { id: 1, name: "åå±±å¤–å›´", req: 1, desc: "çµæ°”ç¨æµ“ï¼Œå¶æœ‰é‡å…½ã€‚", goldMult: 1.5, autoExp: 2, risk: 0.05, powerReq: 10 },
        { id: 2, name: "å¹½å†¥é¬¼æ—", req: 4, desc: "å¦–æ°”å¼¥æ¼«ï¼Œå®ç‰©ä¼—å¤šã€‚", goldMult: 3.0, autoExp: 10, risk: 0.15, powerReq: 50 },
        { id: 3, name: "ä¸Šå¤æˆ˜åœº", req: 6, desc: "å¤§èƒ½é™¨è½ä¹‹åœ°ï¼Œä¹æ­»ä¸€ç”Ÿã€‚", goldMult: 6.0, autoExp: 50, risk: 0.3, powerReq: 200 }
    ];

    // æ‰è½ç‰©å“åº“
    const ITEMS = {
        weapon: [
            { id: 'w1', name: 'ç”Ÿé”ˆé“å‰‘', power: 5, dropRate: 0.2, quality: 'common' },
            { id: 'w2', name: 'ç²¾é’¢é•¿å‰‘', power: 15, dropRate: 0.1, quality: 'common' },
            { id: 'w3', name: 'å¯’å†°åˆƒ', power: 40, dropRate: 0.05, quality: 'rare' },
            { id: 'w4', name: 'ç´«é’åŒå‰‘', power: 120, dropRate: 0.02, quality: 'epic' },
            { id: 'w5', name: 'è½©è¾•ç¥å‰‘', power: 500, dropRate: 0.005, quality: 'legendary' }
        ]
    };

    const defaultState = {
        gold: 0, exp: 0, maxExp: 100, realmIdx: 0, lastSave: Date.now(),
        incomeLvl: 1, clickLvl: 1, petLvl: 0, hasAmulet: false, luckBonus: 0,
        curMapId: 0,
        inventory: [], // èƒŒåŒ…
        weapon: null   // å½“å‰æ­¦å™¨
    };

    let state = { ...defaultState };
    let eventTimer = CONFIG.eventInterval;

    /* --- 2. éšæœºäº‹ä»¶åº“ --- */
    const EVENTS = [
        { t: "è·¯é‡ä¹ä¸", d: "ç–¯è€å¤´ç»™ä½ ä¸€æœ¬ç ´ä¹¦ã€‚", opts: [{txt:"æ”¶ä¸‹", act:(g)=>{g.addExp(100); return {msg:"ä¿®ä¸º+100", cls:"c-exp"};}}, {txt:"èµ°å¼€", act:()=>{return "æ— äº‹å‘ç”Ÿ";}}] },
        { t: "å¤©é™æ¨ªè´¢", d: "è¢«çµçŸ³ç»Šå€’ã€‚", opts: [{txt:"æ¡èµ·", act:(g)=>{state.gold+=100; return {msg:"çµçŸ³+100", cls:"c-gold"};}}] },
        { t: "é»‘å¸‚èµŒçŸ³", d: "èŠ±è´¹200çµçŸ³åˆ‡çŸ³å¤´ã€‚", opts: [{txt:"ä¹°ä¸€å—", act:(g)=>{
            if(state.gold<200) return {msg:"é’±ä¸å¤Ÿ", cls:"c-danger"};
            state.gold-=200;
            return Math.random()>0.6 ? {msg:"åˆ‡æ¶¨äº†ï¼çµçŸ³+500",cls:"c-gold",val:500,act:()=>state.gold+=500} : {msg:"åºŸæ–™ä¸€å—ã€‚",cls:"c-danger"};
        }}, {txt:"ä¸ä¹°", act:()=>"ä½ ç¦»å¼€äº†"}] }
    ];

    /* --- 3. åŠå¸‚å•†å“ --- */
    const MARKET_ITEMS = [
        { id: 'income', name: 'ğŸ’ èšçµé˜µæ³•', type: 'up', base: 50, mult: 1.5, val: s=>s.incomeLvl, eff: s=>`+1/s`, act: s=>{s.incomeLvl++} },
        { id: 'click', name: 'ğŸ“– åçº³å¿ƒæ³•', type: 'up', base: 100, mult: 1.6, val: s=>s.clickLvl, eff: s=>`ç‚¹å‡»+2`, act: s=>{s.clickLvl++} },
        { id: 'pet', name: 'ğŸ¦Š é¥²å…»çµå…½', type: 'up', base: 1000, mult: 1.8, val: s=>s.petLvl, eff: s=>`ä¿®ä¸º+${(s.petLvl+1)*2}/s`, act: s=>{s.petLvl++} },
        { id: 'pill_s', name: 'ğŸ’Š èšæ°”æ•£', type: 'con', cost: 20, eff: ()=>`ä¿®ä¸º+50`, act: s=>game.addExp(50) },
        { id: 'luck', name: 'ğŸ€ æ°”è¿é‡‘é¾™', type: 'con', cost: 300, eff: ()=>`æˆåŠŸç‡+5%`, act: s=>s.luckBonus+=0.05 },
        { id: 'amulet', name: 'ğŸ›¡ï¸ æ›¿èº«è‰äºº', type: 'con', cost: 500, req: s=>!s.hasAmulet, eff: ()=>`ä¿å‘½ä¸€æ¬¡`, act: s=>s.hasAmulet=true }
    ];

    /* --- 4. æ ¸å¿ƒé€»è¾‘ --- */
    const game = {
        init() {
            this.load();
            this.calcOffline();
            this.renderMaps();
            this.renderMarket();
            this.renderInventory(); // åˆå§‹åŒ–èƒŒåŒ…
            this.updateMapBanner();
            this.updateUI();
            setInterval(() => this.tick(), 1000);
            setInterval(() => this.save(), 10000);
            ui.log("æ¬¢è¿é“å‹ï¼å‰å¾€å±é™©åŒºåŸŸå†ç»ƒå¯è·å¾—å¼ºåŠ›é£å‰‘ï¼");
        },

        tick() {
            const map = MAPS[state.curMapId];
            const baseIncome = this.getIncomeRate();
            state.gold += baseIncome * map.goldMult;

            let autoExp = (state.petLvl * 2) + map.autoExp;
            if(autoExp > 0) this.addExp(autoExp);

            if (map.risk > 0 && Math.random() < map.risk) {
                this.triggerCombat(map);
            }

            eventTimer--;
            if(eventTimer <= 0) {
                this.triggerEvent();
                eventTimer = CONFIG.eventInterval;
            }
            this.updateUI();
        },

        // æ‰è½æ£€æµ‹é€»è¾‘
        checkDrop(mapId) {
            if(mapId === 0) return null;
            const roll = Math.random();
            for(let w of ITEMS.weapon) {
                // åœ°å›¾ç­‰çº§è¶Šé«˜(mapIdå¤§)ï¼Œç¨€æœ‰ç‰©å“æ‰è½ç‡å¾®è°ƒ
                let rate = w.dropRate;
                if (mapId >= 2 && w.quality !== 'common') rate *= 1.5; // é«˜çº§åœ°å›¾åŠ æˆ
                if (roll < rate) {
                    return { ...w, uuid: Date.now() + Math.random() }; // ç”Ÿæˆå”¯ä¸€ç‰©å“
                }
            }
            return null;
        },

        triggerCombat(map) {
            const playerPower = this.getPower();
            const mobPower = Math.floor(map.powerReq * (0.8 + Math.random() * 0.4));
            
            if (playerPower >= mobPower) {
                const rewardGold = Math.floor(mobPower * 2);
                const rewardExp = Math.floor(mobPower * 1.5);
                state.gold += rewardGold;
                this.addExp(rewardExp);
                
                // æˆ˜æ–—èƒœåˆ©æ£€æŸ¥æ‰è½
                const drop = this.checkDrop(map.id);
                if (drop) {
                    state.inventory.push(drop);
                    ui.log(`æ–©æ€å¦–å…½ï¼ç«Ÿç„¶æ‰è½äº† <span class="quality-${drop.quality}">[${drop.name}]</span>ï¼`, "c-safe");
                    this.renderInventory();
                    // æ·»åŠ çº¢ç‚¹æç¤ºæ•ˆæœ
                    const invTab = document.querySelector('.nav-item:nth-child(3)');
                    if(!invTab.classList.contains('active')) invTab.style.color = '#69f0ae';
                } else {
                    ui.log(`å‡»è´¥å¦–å…½(æˆ˜åŠ›${mobPower})ï¼Œè·çµçŸ³${rewardGold}ï¼Œä¿®ä¸º${rewardExp}`, "c-gold");
                }

            } else {
                state.curMapId = 0; // å›åŸ
                const loss = Math.floor(state.gold * 0.1);
                state.gold -= loss;
                ui.log(`é­é‡å¤§å¦–(æˆ˜åŠ›${mobPower})ï¼Œä¸æ•Œé‡ä¼¤ï¼é€ƒå›æ´åºœï¼ŒæŸå¤±çµçŸ³${loss}`, "c-danger");
                this.renderMaps();
                this.updateMapBanner();
            }
        },

        getPower() { 
            let base = (state.realmIdx + 1) * 5 + (state.clickLvl * 2);
            if (state.weapon) base += state.weapon.power;
            return base;
        },
        getIncomeRate() { return 1 + Math.floor((state.incomeLvl - 1) * 1.5); },
        getClickPower() { return 1 + Math.floor(state.realmIdx * 1.5) + (state.clickLvl - 1) * 2; },

        switchMap(id) {
            const map = MAPS[id];
            if (state.realmIdx < map.req) {
                ui.log(`å¢ƒç•Œä¸è¶³ï¼éœ€è¾¾åˆ° [${CONFIG.realms[map.req]}]`, "c-danger");
                return;
            }
            state.curMapId = id;
            ui.log(`å‰å¾€ [${map.name}] å†ç»ƒã€‚`, "c-exp");
            this.renderMaps();
            this.updateMapBanner();
            this.updateUI();
        },

        manualCultivate(e) {
            const gain = this.getClickPower();
            this.addExp(gain);
            let x = e ? e.clientX : window.innerWidth/2;
            let y = e ? e.clientY : window.innerHeight/2;
            ui.showFloatingText(x, y, `+${gain} ä¿®ä¸º`);
        },

        addExp(val) {
            if (state.exp >= state.maxExp) return;
            state.exp += val;
            if (state.exp > state.maxExp) state.exp = state.maxExp;
            this.updateUI();
        },

        buy(idx) {
            const item = MARKET_ITEMS[idx];
            let cost = item.cost || Math.floor(item.base * Math.pow(item.mult, item.val(state)-1));
            if (state.gold >= cost) {
                state.gold -= cost;
                if(item.act) { const r=item.act(state); if(r&&r.act) r.act(); }
                ui.log("è´­ä¹°æˆåŠŸ: " + item.name, "c-gold");
                this.renderMarket();
                this.updateUI();
            } else ui.log("çµçŸ³ä¸è¶³", "c-danger");
        },

        attemptBreakthrough() {
            if(state.exp < state.maxExp) { ui.log("ä¿®ä¸ºæœªæ»¡", "c-danger"); return; }
            let chance = Math.max(0.1, 1.0 - (state.realmIdx * 0.1)) + state.luckBonus;
            if(Math.random() < chance) {
                state.realmIdx++; state.exp=0; state.maxExp=Math.floor(state.maxExp*2.5); state.luckBonus=0;
                ui.log(`çªç ´æˆåŠŸï¼æ™‹å‡ [${CONFIG.realms[state.realmIdx]}]`, "c-exp");
            } else {
                state.luckBonus=0;
                if(state.hasAmulet) { state.hasAmulet=false; ui.log("æ›¿èº«è‰äººæŠµæŒ¡äº†å¤©åŠ«ï¼", "c-safe"); this.renderMarket(); }
                else { state.exp=Math.floor(state.maxExp*0.5); ui.log("çªç ´å¤±è´¥ï¼Œä¿®ä¸ºå¤§æŸï¼", "c-danger"); }
            }
            this.renderMaps(); 
            this.updateUI();
        },

        triggerEvent() {
            const evt = EVENTS[Math.floor(Math.random()*EVENTS.length)];
            const m=document.getElementById('event-modal');
            document.getElementById('modal-title').innerText=evt.t;
            document.getElementById('modal-desc').innerText=evt.d;
            const c=document.getElementById('modal-choices'); c.innerHTML="";
            evt.opts.forEach(o=>{
                const b=document.createElement('button'); b.className='modal-btn'; b.innerText=o.txt;
                b.onclick=()=>{ 
                    const res=o.act(this); 
                    if(typeof res==='object'){ ui.log(res.msg, res.cls); if(res.val) res.act && res.act(); }
                    else ui.log(res);
                    m.style.display="none"; this.updateUI();
                };
                c.appendChild(b);
            });
            m.style.display="flex";
        },

        // æ¸²æŸ“èƒŒåŒ…
        renderInventory() {
            const el = document.getElementById('inventory-list');
            if(state.inventory.length === 0) {
                el.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">ç©ºç©ºå¦‚ä¹Ÿ</div>';
                return;
            }
            el.innerHTML = state.inventory.map((item, index) => `
                <div class="item-slot quality-${item.quality}" onclick="game.equipItem(${index})">
                    <div style="font-weight:bold;">${item.name}</div>
                    <div style="font-size:12px;">æˆ˜åŠ› +${item.power}</div>
                </div>
            `).join('');
            
            this.updateWeaponUI();
        },

        updateWeaponUI() {
            const wName = document.getElementById('equipped-weapon-name');
            const wPow = document.getElementById('equipped-weapon-power');
            if(state.weapon) {
                wName.innerHTML = `<span class="quality-${state.weapon.quality}">${state.weapon.name}</span>`;
                wPow.innerText = `+${state.weapon.power} æˆ˜åŠ›`;
            } else {
                wName.innerText = "æ— ";
                wPow.innerText = "";
            }
        },

        // è£…å¤‡ç‰©å“
        equipItem(index) {
            const item = state.inventory[index];
            if(state.weapon) {
                state.inventory.push(state.weapon); // å¸ä¸‹å½“å‰è£…å¤‡
            }
            state.weapon = item;
            state.inventory.splice(index, 1); // ä»èƒŒåŒ…ç§»é™¤
            
            ui.log(`è£…å¤‡äº† [${item.name}]ï¼Œæˆ˜åŠ›å¤§å¢ï¼`, "c-gold");
            this.renderInventory();
            this.updateUI();
        },

        renderMaps() {
            const list = document.getElementById('map-list'); list.innerHTML = "";
            MAPS.forEach(map => {
                const locked = state.realmIdx < map.req;
                const active = state.curMapId === map.id;
                const div = document.createElement('div'); div.className = 'map-card';
                div.innerHTML = `
                    <div class="map-info">
                        <h3>${map.name} ${active ? '<span style="font-size:12px;color:#69f0ae">(å½“å‰)</span>' : ''}</h3>
                        <div style="font-size:12px; color:#888;">æ”¶ç›Š: x${map.goldMult} | è‡ªåŠ¨ä¿®ä¸º: +${map.autoExp}/s</div>
                        <div style="font-size:12px; color:${map.risk>0?'#ff8a80':'#ccc'}">å±é™©åº¦: ${Math.floor(map.risk*100)}% (å»ºè®®æˆ˜åŠ›: ${map.powerReq||0})</div>
                    </div>
                    <button class="map-btn ${active?'active':''} ${locked?'locked':''}" onclick="game.switchMap(${map.id})">
                        ${locked ? `éœ€${CONFIG.realms[map.req]}` : (active ? 'å†ç»ƒä¸­' : 'å‰å¾€')}
                    </button>
                `;
                list.appendChild(div);
            });
        },

        renderMarket() {
            const l = document.getElementById('market-list'); l.innerHTML="";
            MARKET_ITEMS.forEach((i,idx)=>{
                if(i.req && !i.req(state)) return;
                let cost = i.cost || Math.floor(i.base*Math.pow(i.mult, i.val(state)-1));
                const d = document.createElement('div'); d.className='item-card';
                d.innerHTML=`<div class="item-head"><span style="font-weight:bold;color:#ffd700">${i.name}</span>${i.type=='up'?`<span style="font-size:12px;background:#333;padding:2px">Lv.${i.val(state)}</span>`:''}</div><div style="font-size:12px;color:#888;margin:5px 0 10px 0">${i.eff(state)}</div><button class="btn-buy" onclick="game.buy(${idx})" ${state.gold<cost?'disabled':''}><span>${i.type=='up'?'å‡çº§':'è´­ä¹°'}</span><span>ğŸ’° ${cost}</span></button>`;
                l.appendChild(d);
            });
        },

        updateMapBanner() {
            const map = MAPS[state.curMapId];
            const el = document.getElementById('cur-map-banner');
            el.className = `current-map-banner bg-map-${state.curMapId}`;
            document.getElementById('banner-loc-name').innerText = map.name;
            document.getElementById('banner-risk-text').innerText = map.risk === 0 ? "å®‰å…¨åŒºåŸŸ" : `å±é™©åŒºåŸŸ (é£é™©:${map.risk*100}%)`;
            document.getElementById('banner-bonus-text').innerText = `æ”¶ç›Š x${map.goldMult}`;
            document.getElementById('location-text').innerText = map.name;
        },

        updateUI() {
            document.getElementById('realm-text').innerText = CONFIG.realms[state.realmIdx]||"å¤©å°Š";
            document.getElementById('gold-text').innerText = Math.floor(state.gold);
            document.getElementById('exp-text').innerText = Math.floor(state.exp);
            document.getElementById('max-exp-text').innerText = state.maxExp;
            document.getElementById('event-timer').innerText = eventTimer;
            document.getElementById('power-text').innerText = this.getPower();
            document.getElementById('click-val-disp').innerText = this.getClickPower();
            
            const pct = Math.min(100, (state.exp/state.maxExp)*100);
            document.getElementById('exp-bar').style.width = pct + "%";
            document.getElementById('chance-text').innerText = Math.min(100,Math.floor((Math.max(0.1, 1.0-(state.realmIdx*0.1))+state.luckBonus)*100))+"%";
            document.getElementById('amulet-status').style.display=state.hasAmulet?'block':'none';

            const map = MAPS[state.curMapId];
            document.getElementById('income-text').innerText = (this.getIncomeRate() * map.goldMult).toFixed(1);
            document.getElementById('map-mult-text').innerText = `x${map.goldMult}`;
            
            const btns = document.querySelectorAll('.btn-buy');
            MARKET_ITEMS.forEach((i,idx)=>{
                if(btns[idx]) {
                    let cost = i.cost || Math.floor(i.base*Math.pow(i.mult, i.val(state)-1));
                    btns[idx].disabled = state.gold < cost;
                }
            });
        },
        
        calcOffline() {
            const dt = Math.floor((Date.now()-state.lastSave)/1000);
            if(dt>10) {
                const baseInc = this.getIncomeRate();
                state.gold += dt * baseInc;
                const petExp = dt * (state.petLvl*2);
                if(petExp>0) this.addExp(petExp);
                ui.log(`ç¦»çº¿${dt}ç§’ï¼Œè‡ªåŠ¨æ”¶ç›ŠçµçŸ³${dt*baseInc}` + (petExp?`ï¼Œä¿®ä¸º${petExp}`:''), "c-exp");
            }
        },
        save(){ state.lastSave=Date.now(); localStorage.setItem('xiuxian_v10', JSON.stringify(state)); }, // Version updated to v10
        load(){ const d=localStorage.getItem('xiuxian_v10'); if(d) state={...state,...JSON.parse(d)}; }
    };

    const ui = {
        switchTab(t,e){
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); e.classList.add('active');
            e.style.color = ''; // Remove highlight if any
            document.querySelectorAll('.view-content').forEach(x=>x.classList.add('hidden')); document.getElementById('view-'+t).classList.remove('hidden');
        },
        log(m,c){
            const b=document.getElementById('log-container'); const d=document.createElement('div');
            d.innerHTML=`<span class="log-time">[${new Date().toLocaleTimeString('zh-CN',{hour12:false})}]</span><span class="${c||''}">${m}</span>`;
            b.appendChild(d); b.scrollTop=b.scrollHeight;
        },
        showFloatingText(x,y,t){
            const e=document.createElement('div'); e.className='floating-text'; e.innerText=t;
            e.style.left=x+'px'; e.style.top=y+'px'; document.body.appendChild(e); setTimeout(()=>e.remove(),800);
        }
    };

    game.init();
</script>
</body>
</html>